generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
   url      = "postgresql://postgres:keToEoQtvpjGOLSZnGnYBcVQCXlJwUyR@ballast.proxy.rlwy.net:40314/railway"
}

model User {
  id                   String          @id @default(uuid())
  email                String          @unique
  name                 String?
  role                 UserRole        @default(GESTOR)
  password             String
  activo               Boolean         @default(true)
  cargo                String?
  proceso              String?
  idColaborador        String?
  createdAt            DateTime        @default(now())
  updatedAt            DateTime        @updatedAt
  fechaInactivacion    DateTime?
  actividades          Actividad[]
  aprobaciones         Aprobacion[]
  casosCreados         Caso[]          @relation("CasosCreados")
  casosAsignados       Caso[]          @relation("CasosAsignados")
  documentos           Documento[]
  entidadesResponsable Entidad[]       @relation("ResponsableEntidad")
  revisiones           Revision[]
  notificaciones       Notification[]  // RELACIÓN AGREGADA

  @@map("users")
}

model Entidad {
  id                      String   @id @default(uuid())
  nombre                  String   @unique
  sigla                   String?
  email                   String?
  descripcion             String?
  color                   String?
  activo                  Boolean  @default(true)
  dominiosCorreo          Json?
  palabrasClave           Json?
  tiempoRespuestaDias     Int?
  responsablePorDefectoId String?
  createdAt               DateTime @default(now())
  updatedAt               DateTime @updatedAt
  casos                   Caso[]
  responsablePorDefecto   User?    @relation("ResponsableEntidad", fields: [responsablePorDefectoId], references: [id])

  @@map("entidades")
}

model Caso {
  id                    String          @id @default(uuid())
  asunto                String
  descripcion           String?
  prioridad             Prioridad       @default(MEDIA)
  estado                EstadoCaso      @default(PENDIENTE)
  etapaAprobacion       EtapaAprobacion @default(RECIBIDO)
  tipoSolicitud         TipoSolicitud?
  numeroRadicadoEntrada String?
  numeroRadicadoSalida  String?
  idGLPI                String?
  emailId               String?         @unique
  entidadId             String
  responsableId         String?
  creadorId             String?
  fechaRecepcion        DateTime        @default(now())
  fechaVencimiento      DateTime?
  fechaInicioRedaccion  DateTime?
  fechaEnvioRevision    DateTime?
  fechaRevision         DateTime?
  fechaEnvioAprobacion  DateTime?
  fechaAprobacion       DateTime?
  fechaEnvioFirma       DateTime?
  fechaFirmaLegal       DateTime?
  fechaEnvioFinal       DateTime?
  fechaAcuseRecibo      DateTime?
  fechaCierre           DateTime?
  createdAt             DateTime        @default(now())
  updatedAt             DateTime        @updatedAt
  actividades           Actividad[]
  aprobaciones          Aprobacion[]
  creador               User?           @relation("CasosCreados", fields: [creadorId], references: [id])
  responsable           User?           @relation("CasosAsignados", fields: [responsableId], references: [id])
  entidad               Entidad         @relation(fields: [entidadId], references: [id])
  email                 Email?          @relation(fields: [emailId], references: [id])
  documentos            Documento[]
  revisiones            Revision[]
  notificaciones        Notification[]  // RELACIÓN AGREGADA

  @@map("casos")
}

model Email {
  id                 String     @id @default(uuid())
  messageId          String     @unique
  from               String
  to                 String
  subject            String
  body               String
  html               String?
  fecha              DateTime
  attachments        Json?
  entidadDetectada   String?
  prioridadDetectada Prioridad?
  procesado          Boolean    @default(false)
  clasificado        Boolean    @default(false)
  createdAt          DateTime   @default(now())
  
  // NUEVOS CAMPOS PARA FILTRADO Y NOTIFICACIONES
  numeroRadicado     String?    // Extraído del asunto/cuerpo
  remitenteOriginal  String?    // Nombre del remitente
  dominioRemitente   String?    // Dominio para detectar entidad
  palabrasClave      String[]   // Para búsqueda
  esEntidadControl   Boolean    @default(false)
  notificado         Boolean    @default(false) // ✅ NUEVO: Controlar si ya se notificó
  
  // RELACIÓN CON CASO
  caso               Caso?

  @@map("emails")
}

model Actividad {
  id          String        @id @default(uuid())
  tipo        TipoActividad
  descripcion String
  metadata    Json?
  archivoUrl  String?
  casoId      String
  usuarioId   String
  fecha       DateTime      @default(now())
  usuario     User          @relation(fields: [usuarioId], references: [id])
  caso        Caso          @relation(fields: [casoId], references: [id])

  @@map("actividades")
}

model Documento {
  id          String   @id @default(uuid())
  nombre      String
  tipo        String
  url         String
  mimeType    String?
  tamano      Int?
  version     Int      @default(1)
  driveId     String?
  esPlantilla Boolean  @default(false)
  casoId      String?
  usuarioId   String
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  usuario     User     @relation(fields: [usuarioId], references: [id])
  caso        Caso?    @relation(fields: [casoId], references: [id])

  @@map("documentos")
}

model Revision {
  id              String         @id @default(uuid())
  estado          EstadoRevision @default(PENDIENTE)
  comentario      String?
  casoId          String
  revisorId       String
  fechaAsignacion DateTime       @default(now())
  fechaRevision   DateTime?
  revisor         User           @relation(fields: [revisorId], references: [id])
  caso            Caso           @relation(fields: [casoId], references: [id])

  @@map("revisiones")
}

model Aprobacion {
  id              String           @id @default(uuid())
  estado          EstadoAprobacion @default(PENDIENTE)
  comentario      String?
  casoId          String
  aprobadorId     String
  fechaAsignacion DateTime         @default(now())
  fechaAprobacion DateTime?
  aprobador       User             @relation(fields: [aprobadorId], references: [id])
  caso            Caso             @relation(fields: [casoId], references: [id])

  @@map("aprobaciones")
}

model Notification {
  id          String   @id @default(uuid())
  type        String   // 'success', 'error', 'warning', 'info'
  title       String
  message     String
  read        Boolean  @default(false)
  userId      String
  casoId      String?
  timestamp   DateTime @default(now())
  
  // ✅ RELACIONES CORREGIDAS
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  caso        Caso?    @relation(fields: [casoId], references: [id], onDelete: Cascade)

  @@map("notifications")
  @@index([userId])
  @@index([read])
  @@index([timestamp])
  @@index([userId, read])
}

enum UserRole {
  ADMINISTRADOR_SISTEMA
  ADMINISTRADOR_ASIGNACIONES
  GESTOR
  REVISOR_JURIDICO
  APROBADOR
  ROL_SEGUIMIENTO
  AUDITOR
}

enum Prioridad {
  MUY_ALTA
  ALTA
  MEDIA
  BAJA
}

enum EstadoCaso {
  PENDIENTE
  ASIGNADO
  EN_REDACCION
  EN_REVISION
  EN_APROBACION
  FIRMA_LEGAL
  LISTO_ENVIO
  ENVIADO
  CON_ACUSE
  CERRADO
}

enum EtapaAprobacion {
  RECIBIDO
  ASIGNADO
  EN_REDACCION
  EN_REVISION
  EN_APROBACION
  FIRMA_LEGAL
  LISTO_ENVIO
  ENVIADO
  CON_ACUSE
  CERRADO
}

enum TipoSolicitud {
  SOLICITUD_INFORMACION
  AUDITORIA
  RESPUESTA_COMUNICADO
  REQUERIMIENTO_JUDICIAL
  SOLICITUD_VIABILIDAD
  CONSULTA_JURIDICA
  CONSULTA_GENERAL
  REPORTE_OBLIGATORIO
  OTRO
}

enum TipoActividad {
  CREACION
  ASIGNACION
  CAMBIO_ESTADO
  COMENTARIO
  VENCIMIENTO
  INICIO_REDACCION
  ENVIO_REVISION
  ENVIO_APROBACION
  APROBACION
  RECHAZO
  FIRMA_LEGAL
  ENVIO_FINAL
  ACUSE_RECIBO
}

enum EstadoRevision {
  PENDIENTE
  REVISADO
  CORREGIR
  RECHAZADO
}

enum EstadoAprobacion {
  PENDIENTE
  APROBADO
  CORREGIR
  RECHAZADO
}