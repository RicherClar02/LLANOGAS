// prisma/schema.prisma - VERSIÓN AVANZADA Y COMPLETA

generator client {
  provider = "prisma-client-js"
}

datasource db {
  // Asegúrate de que tu URL de conexión sea la correcta.
  // Si sigues usando SQLite, cambia "postgresql" a "sqlite" y la url.
  provider = "sqlite"
  url      = "file:./dev.db"
}

model User {
  id        String    @id @default(uuid()) // Cambiado de cuid() a uuid() para consistencia
  email     String    @unique
  name      String?   // 'name' debe ser opcional para el login
  role      UserRole  @default(GESTOR)   // <-- CAMBIO CLAVE
  password  String
  activo    Boolean   @default(true)
  
  // Información adicional para auditoría
  cargo         String?
  proceso       String?
  idColaborador String?
  
  // Timestamps
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt
  fechaInactivacion DateTime?

  // Relations
  casosAsignados       Caso[]       @relation("CasosAsignados")
  actividades          Actividad[]
  documentos           Documento[]
  casosCreados         Caso[]       @relation("CasosCreados")
  revisiones           Revision[]
  aprobaciones         Aprobacion[]
  entidadesResponsable Entidad[]    @relation("ResponsableEntidad")

  @@map("users")
}

model Entidad {
  id        String  @id @default(uuid()) // Cambiado de cuid() a uuid()
  nombre    String  @unique
  sigla     String? // Sigla puede ser opcional
  email     String?
  descripcion String?
  color     String? // Color puede ser opcional
  activo    Boolean @default(true)

  // Campos para clasificación automática
  dominiosCorreo        Json?
  palabrasClave         Json?
  tiempoRespuestaDias   Int? // Puede ser opcional

  // Responsable por defecto
  responsablePorDefectoId String?
  responsablePorDefecto   User?   @relation("ResponsableEntidad", fields: [responsablePorDefectoId], references: [id])

  casos Caso[]

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("entidades")
}

model Caso {
  id          String   @id @default(uuid()) // Cambiado de cuid() a uuid()
  asunto      String
  descripcion String?
  prioridad   Prioridad @default(MEDIA)
  estado      EstadoCaso @default(PENDIENTE) // <-- CAMBIO CLAVE
  
  // Workflow de aprobación
  etapaAprobacion EtapaAprobacion @default(RECIBIDO)
  tipoSolicitud   TipoSolicitud? // Puede ser opcional al inicio

  // Información de radicados
  numeroRadicadoEntrada String?
  numeroRadicadoSalida  String?
  idGLPI                String?

  // Relación con email original
  emailId String? @unique
  email   Email?  @relation(fields: [emailId], references: [id])

  // Entidad y responsables
  entidadId String
  entidad   Entidad @relation(fields: [entidadId], references: [id])

  responsableId String?
  responsable   User?   @relation("CasosAsignados", fields: [responsableId], references: [id], onDelete: SetNull)

  creadorId String? // Puede ser opcional si el sistema lo crea
  creador   User?   @relation("CasosCreados", fields: [creadorId], references: [id])

  // Fechas del workflow
  fechaRecepcion       DateTime  @default(now())
  fechaVencimiento     DateTime?
  fechaInicioRedaccion DateTime?
  fechaEnvioRevision   DateTime?
  fechaRevision        DateTime?
  fechaEnvioAprobacion DateTime?
  fechaAprobacion      DateTime?
  fechaEnvioFirma      DateTime?
  fechaFirmaLegal      DateTime?
  fechaEnvioFinal      DateTime?
  fechaAcuseRecibo     DateTime?
  fechaCierre          DateTime?

  // Relations
  actividades  Actividad[]
  documentos   Documento[]
  revisiones   Revision[]
  aprobaciones Aprobacion[]

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("casos")
}

model Email {
  id        String   @id @default(uuid()) // Cambiado de cuid() a uuid()
  messageId String   @unique
  from      String
  to        String
  subject   String
  body      String
  html      String?
  fecha     DateTime

  // Adjuntos (JSON es más flexible para almacenar listas de archivos)
  attachments Json?

  // Procesamiento
  entidadDetectada   String?
  prioridadDetectada Prioridad?
  procesado          Boolean   @default(false)
  clasificado        Boolean   @default(false)

  caso Caso?

  createdAt DateTime @default(now())

  @@map("emails")
}

model Actividad {
  id          String        @id @default(uuid()) // Cambiado de cuid() a uuid()
  tipo        TipoActividad
  descripcion String
  metadata    Json?
  archivoUrl  String?       // <-- Mantenemos el campo de archivo

  casoId String
  caso   Caso   @relation(fields: [casoId], references: [id])

  usuarioId String
  usuario   User   @relation(fields: [usuarioId], references: [id])

  fecha DateTime @default(now())

  @@map("actividades")
}

model Documento {
  id        String   @id @default(uuid()) // Cambiado de cuid() a uuid()
  nombre    String
  tipo      String
  url       String   // URL al almacenamiento (S3, GCS, o local /public/uploads)
  tamano    Int?
  version   Int      @default(1)
  
  driveId     String?
  esPlantilla Boolean @default(false)

  casoId String?
  caso   Caso?   @relation(fields: [casoId], references: [id])

  usuarioId String
  usuario   User   @relation(fields: [usuarioId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("documentos")
}

model Revision {
  id        String         @id @default(uuid()) // Cambiado de cuid() a uuid()
  estado    EstadoRevision @default(PENDIENTE)
  comentario String?
  
  casoId String
  caso   Caso   @relation(fields: [casoId], references: [id])
  
  revisorId String
  revisor   User   @relation(fields: [revisorId], references: [id])
  
  fechaAsignacion DateTime  @default(now())
  fechaRevision   DateTime?
  
  @@map("revisiones")
}

model Aprobacion {
  id        String           @id @default(uuid()) // Cambiado de cuid() a uuid()
  estado    EstadoAprobacion @default(PENDIENTE)
  comentario String?
  
  casoId      String
  caso        Caso   @relation(fields: [casoId], references: [id])
  
  aprobadorId String
  aprobador   User   @relation(fields: [aprobadorId], references: [id])
  
  fechaAsignacion DateTime  @default(now())
  fechaAprobacion DateTime?
  
  @@map("aprobaciones")
}

// ENUMS (La parte más importante de esta actualización)
enum UserRole {
  ADMINISTRADOR_SISTEMA
  ADMINISTRADOR_ASIGNACIONES
  GESTOR
  REVISOR_JURIDICO
  APROBADOR
  ROL_SEGUIMIENTO
  AUDITOR
}

enum Prioridad {
  MUY_ALTA
  ALTA
  MEDIA
  BAJA
}

enum EstadoCaso {
  PENDIENTE
  ASIGNADO
  EN_REDACCION
  EN_REVISION
  EN_APROBACION
  FIRMA_LEGAL
  LISTO_ENVIO
  ENVIADO
  CON_ACUSE
  CERRADO
}

enum EtapaAprobacion {
  RECIBIDO
  ASIGNADO
  EN_REDACCION
  EN_REVISION
  EN_APROBACION
  FIRMA_LEGAL
  LISTO_ENVIO
  ENVIADO
  CON_ACUSE
}

enum TipoSolicitud {
  SOLICITUD_INFORMACION
  AUDITORIA
  RESPUESTA_COMUNICADO
  REQUERIMIENTO_JUDICIAL
  SOLICITUD_VIABILIDAD
  CONSULTA_JURIDICA
  REPORTE_OBLIGATORIO
  OTRO
}

enum TipoActividad {
  CREACION
  ASIGNACION
  CAMBIO_ESTADO
  COMENTARIO
  VENCIMIENTO
  INICIO_REDACCION
  ENVIO_REVISION
  ENVIO_APROBACION
  APROBACION
  RECHAZO
  FIRMA_LEGAL
  ENVIO_FINAL
  ACUSE_RECIBO
}

enum EstadoRevision {
  PENDIENTE
  REVISADO
  CORREGIR
  RECHAZADO
}

enum EstadoAprobacion {
  PENDIENTE
  APROBADO
  CORREGIR
  RECHAZADO
}